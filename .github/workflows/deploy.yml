name: Deploy Services

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: self-hosted
    outputs:
      changed-services: ${{ steps.changed-services.outputs.changed_services }}
      deleted-services: ${{ steps.changed-services.outputs.deleted_services }}
      all-services: ${{ steps.changed-services.outputs.all_services }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: services/**
          dir_names: true
          dir_names_max_depth: 2

      - name: Detect changed services
        id: changed-services
        run: |
          # Get all changed directories in services/
          changed_dirs="${{ steps.changed-files.outputs.all_changed_files }}"
          deleted_dirs="${{ steps.changed-files.outputs.deleted_files }}"

          # Initialize arrays
          changed_services=()
          deleted_services=()
          all_services=()

          # Get all existing services
          if [ -d "services" ]; then
            for service_dir in services/*/; do
              if [ -d "$service_dir" ]; then
                service_name=$(basename "$service_dir")
                all_services+=("$service_name")
              fi
            done
          fi

          # Process changed directories (existing services that changed)
          for dir in $changed_dirs; do
            if [[ "$dir" == services/* ]]; then
              # Extract service name (first subdirectory under services/)
              service_path=${dir#services/}
              service_name=${service_path%%/*}
              
              if [ -n "$service_name" ] && [ "$service_name" != "services" ]; then
                if [ -d "services/$service_name" ]; then
                  # Service still exists, it's changed
                  if [[ ! " ${changed_services[@]} " =~ " ${service_name} " ]]; then
                    changed_services+=("$service_name")
                  fi
                fi
              fi
            fi
          done

          # Process deleted directories (services that were removed)
          for dir in $deleted_dirs; do
            if [[ "$dir" == services/* ]]; then
              # Extract service name (first subdirectory under services/)
              service_path=${dir#services/}
              service_name=${service_path%%/*}
              
              if [ -n "$service_name" ] && [ "$service_name" != "services" ]; then
                # Add to deleted services if not already present
                if [[ ! " ${deleted_services[@]} " =~ " ${service_name} " ]]; then
                  deleted_services+=("$service_name")
                fi
              fi
            fi
          done

          # Convert arrays to JSON (compact format for GitHub Actions)
          if [ ${#changed_services[@]} -eq 0 ]; then
            changed_services_json="[]"
          else
            changed_services_json=$(printf '%s\n' "${changed_services[@]}" | jq -R . | jq -s -c .)
          fi

          if [ ${#deleted_services[@]} -eq 0 ]; then
            deleted_services_json="[]"
          else
            deleted_services_json=$(printf '%s\n' "${deleted_services[@]}" | jq -R . | jq -s -c .)
          fi

          if [ ${#all_services[@]} -eq 0 ]; then
            all_services_json="[]"
          else
            all_services_json=$(printf '%s\n' "${all_services[@]}" | jq -R . | jq -s -c .)
          fi

          echo "changed_services=$changed_services_json" >> $GITHUB_OUTPUT
          echo "deleted_services=$deleted_services_json" >> $GITHUB_OUTPUT
          echo "all_services=$all_services_json" >> $GITHUB_OUTPUT

          echo "Changed services: $changed_services_json"
          echo "Deleted services: $deleted_services_json"
          echo "All services: $all_services_json"

  stop-deleted-services:
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.deleted-services != '[]'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.deleted-services) }}
    steps:
      - name: Stop and remove deleted service
        run: |
          echo "Stopping and removing service: ${{ matrix.service }}"

          # Stop and remove containers
          docker compose -p "${{ matrix.service }}" down --remove-orphans || true

          # Remove unused volumes (optional, be careful with this)
          # docker volume prune -f

          echo "Service ${{ matrix.service }} has been stopped and removed"

  deploy-changed-services:
    runs-on: self-hosted
    needs: detect-changes
    if: needs.detect-changes.outputs.changed-services != '[]'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed-services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate service configuration
        run: |
          service_dir="services/${{ matrix.service }}"

          if [ ! -d "$service_dir" ]; then
            echo "Error: Service directory $service_dir does not exist"
            exit 1
          fi

          if [ ! -f "$service_dir/docker-compose.yml" ] && [ ! -f "$service_dir/docker-compose.yaml" ]; then
            echo "Error: No docker-compose file found in $service_dir"
            exit 1
          fi

          echo "Service ${{ matrix.service }} configuration is valid"

      - name: Deploy service
        run: |
          service_dir="services/${{ matrix.service }}"
          cd "$service_dir"

          echo "Deploying service: ${{ matrix.service }}"

          # Stop existing containers
          docker compose -p "${{ matrix.service }}" down || true

          # Pull latest images
          docker compose -p "${{ matrix.service }}" pull

          # Start the service
          docker compose -p "${{ matrix.service }}" up -d

          # Wait a moment for the service to start
          sleep 5

          # Check if containers are running
          if docker compose -p "${{ matrix.service }}" ps --services --filter "status=running" | grep -q .; then
            echo "Service ${{ matrix.service }} deployed successfully"
          else
            echo "Warning: Some containers in service ${{ matrix.service }} may not be running"
            docker compose -p "${{ matrix.service }}" ps
          fi

  health-check-and-recovery:
    runs-on: self-hosted
    needs: [detect-changes, deploy-changed-services, stop-deleted-services]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Health check and service recovery
        run: |
          echo "=== Docker System Overview ==="
          docker system df

          echo "=== Running Containers ==="
          docker ps

          echo "=== Docker Compose Services ==="
          docker compose ls || true

          echo ""
          echo "=== Service Health Check and Recovery ==="

          # Get all services that should be running
          services_to_check=()
          if [ -d "services" ]; then
            for service_dir in services/*/; do
              if [ -d "$service_dir" ]; then
                service_name=$(basename "$service_dir")
                services_to_check+=("$service_name")
              fi
            done
          fi

          echo "Services to check: ${services_to_check[*]}"

          # Check each service and recover if needed
          failed_services=()
          recovered_services=()

          for service in "${services_to_check[@]}"; do
            echo ""
            echo "--- Checking service: $service ---"
            
            service_dir="services/$service"
            cd "$service_dir"
            
            # Check if service containers are running
            running_containers=$(docker compose -p "$service" ps --services --filter "status=running" 2>/dev/null || echo "")
            total_containers=$(docker compose -p "$service" ps --services 2>/dev/null || echo "")
            
            if [ -z "$running_containers" ] || [ -z "$total_containers" ]; then
              echo "‚ùå Service $service has no containers or is not running"
              failed_services+=("$service")
              
              echo "üîÑ Attempting to recover service: $service"
              
              # Stop any existing containers
              docker compose -p "$service" down || true
              
              # Pull latest images
              echo "üì• Pulling latest images for $service..."
              docker compose -p "$service" pull || echo "Warning: Failed to pull images for $service"
              
              # Start the service
              echo "üöÄ Starting service: $service"
              if docker compose -p "$service" up -d; then
                echo "‚úÖ Successfully started $service"
                
                # Wait a moment for containers to start
                sleep 10
                
                # Verify the service is now running
                new_running=$(docker compose -p "$service" ps --services --filter "status=running" 2>/dev/null || echo "")
                if [ -n "$new_running" ]; then
                  echo "‚úÖ Service $service is now healthy"
                  recovered_services+=("$service")
                else
                  echo "‚ùå Service $service failed to start properly"
                  echo "Container status:"
                  docker compose -p "$service" ps
                  echo "Container logs:"
                  docker compose -p "$service" logs --tail=20
                fi
              else
                echo "‚ùå Failed to start service: $service"
                echo "Container status:"
                docker compose -p "$service" ps
              fi
            else
              echo "‚úÖ Service $service is healthy"
              
              # Still show container status for info
              echo "Container status:"
              docker compose -p "$service" ps
            fi
            
            cd - > /dev/null
          done

          echo ""
          echo "=== Recovery Summary ==="
          echo "Total services checked: ${#services_to_check[@]}"
          echo "Failed services found: ${#failed_services[@]}"
          echo "Services recovered: ${#recovered_services[@]}"

          if [ ${#failed_services[@]} -gt 0 ]; then
            echo "Failed services: ${failed_services[*]}"
          fi

          if [ ${#recovered_services[@]} -gt 0 ]; then
            echo "Recovered services: ${recovered_services[*]}"
          fi

          # Final status check
          echo ""
          echo "=== Final System Status ==="
          docker ps

          remaining_failed=$((${#failed_services[@]} - ${#recovered_services[@]}))
          if [ $remaining_failed -gt 0 ]; then
            echo "‚ö†Ô∏è  Warning: $remaining_failed service(s) could not be recovered"
            exit 1
          else
            echo "‚úÖ All services are healthy!"
          fi

          echo "Deployment and health check workflow completed"
