name: Deploy to Raspberry Pi

on:
  push:
    branches: [ "main" ]
    paths:
      - 'services/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

concurrency:
  group: deploy-home-server
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    env:
      # Make secrets available to all compose runs. Add more here as your services require.
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy changed services and stop removed ones
        shell: bash
        run: |
          set -euo pipefail

          # Persistent cache for compose files of deployed services
          DEPLOY_STATE_DIR="${DEPLOY_STATE_DIR:-$HOME/.home-server-deploy/services}"

          AFTER_SHA="${GITHUB_SHA}"
          BEFORE_SHA="${{ github.event.before }}"

          if [[ -z "${BEFORE_SHA}" || "${BEFORE_SHA}" == "0000000000000000000000000000000000000000" ]]; then
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              BEFORE_SHA="$(git rev-parse HEAD^)"
            else
              BEFORE_SHA="$(git rev-list --max-parents=0 -n 1 HEAD)"
            fi
          fi

          echo "Before: ${BEFORE_SHA}"
          echo "After:  ${AFTER_SHA}"

          mkdir -p "${DEPLOY_STATE_DIR}"

          # Current services in workspace (dirs under services/* that contain compose.yml/yaml)
          mapfile -t CURRENT_SERVICES < <(find services -mindepth 2 -maxdepth 2 \( -name 'compose.yaml' -o -name 'compose.yml' \) -print \
            | awk -F/ '{print $2}' | sort -u)

          # Services present in the previous commit
          mapfile -t PREV_SERVICES < <(git ls-tree -r --name-only "${BEFORE_SHA}" -- services 2>/dev/null \
            | awk -F/ '/(^|\/)compose\.(ya)?ml$/{print $2}' | sort -u || true)

          # Services that have any file changes in this push
          mapfile -t CHANGED_SERVICES < <(git diff --name-only "${BEFORE_SHA}" "${AFTER_SHA}" -- services 2>/dev/null \
            | awk -F/ '{print $2}' | sort -u || true)

          # Helper to test membership
          in_list() { local x="$1"; shift; for i in "$@"; do [[ "$i" == "$x" ]] && return 0; done; return 1; }

          echo "Current services: ${CURRENT_SERVICES[*]:-<none>}"
          echo "Previous services: ${PREV_SERVICES[*]:-<none>}"
          echo "Changed services: ${CHANGED_SERVICES[*]:-<none>}"

          # Determine removed services = prev - current
          REMOVED_SERVICES=()
          for svc in "${PREV_SERVICES[@]:-}"; do
            if ! in_list "$svc" "${CURRENT_SERVICES[@]:-}"; then
              REMOVED_SERVICES+=("$svc")
            fi
          done

          echo "Removed services: ${REMOVED_SERVICES[*]:-<none>}"

          # If workflow changed in this push, redeploy all current services
          if git diff --name-only "${BEFORE_SHA}" "${AFTER_SHA}" -- '.github/workflows/deploy.yml' | grep -q .; then
            echo "Workflow changed; marking all current services for deployment"
            CHANGED_SERVICES=("${CURRENT_SERVICES[@]:-}")
          fi

          # Also deploy services that have never been deployed (no state dir) or are not currently running
          EXTRA_DEPLOY=()
          for svc in "${CURRENT_SERVICES[@]:-}"; do
            need=false
            [[ ! -d "${DEPLOY_STATE_DIR}/$svc" ]] && need=true
            if [[ "$need" == false ]]; then
              pushd "services/$svc" >/dev/null
              running_count=$(docker compose -f compose.yaml ps --status=running --services | wc -l || true)
              popd >/dev/null
              [[ "${running_count}" -eq 0 ]] && need=true
            fi
            if [[ "$need" == true ]]; then
              EXTRA_DEPLOY+=("$svc")
            fi
          done

          # Union of CHANGED_SERVICES and EXTRA_DEPLOY (unique)
          DEPLOY_SET=()
          add_unique() { local v; for v in "$@"; do in_list "$v" "${DEPLOY_SET[@]:-}" || DEPLOY_SET+=("$v"); done; }
          add_unique "${CHANGED_SERVICES[@]:-}"
          add_unique "${EXTRA_DEPLOY[@]:-}"

          echo "Will deploy: ${DEPLOY_SET[*]:-<none>}"

          # Deploy selected services (continue on failure per service)
          FAILURES=()
          for svc in "${DEPLOY_SET[@]:-}"; do
            if in_list "$svc" "${CURRENT_SERVICES[@]:-}"; then
              echo "Deploying: $svc"
              pushd "services/$svc" >/dev/null
              success=true
              if ! docker compose -f compose.yaml pull | cat; then
                echo "[WARN] Pull failed for $svc"
                success=false
              fi
              if ! docker compose -f compose.yaml up -d --remove-orphans | cat; then
                echo "[WARN] Up failed for $svc"
                success=false
              fi
              popd >/dev/null
              if [[ "$success" == true ]]; then
                mkdir -p "${DEPLOY_STATE_DIR}/$svc"
                rm -rf "${DEPLOY_STATE_DIR}/$svc"/* 2>/dev/null || true
                mkdir -p "${DEPLOY_STATE_DIR}/$svc"
                cp -a "services/$svc/." "${DEPLOY_STATE_DIR}/$svc/"
              else
                FAILURES+=("$svc")
              fi
            fi
          done

          if [[ ${#FAILURES[@]} -gt 0 ]]; then
            echo "The following services failed to deploy: ${FAILURES[*]}"
          fi

          # Stop services removed from the repo
          for svc in "${REMOVED_SERVICES[@]:-}"; do
            if [[ -d "${DEPLOY_STATE_DIR}/$svc" ]]; then
              echo "Stopping removed service: $svc"
              pushd "${DEPLOY_STATE_DIR}/$svc" >/dev/null
              docker compose -f compose.yaml down | cat || true
              popd >/dev/null
              rm -rf "${DEPLOY_STATE_DIR}/$svc"
            else
              echo "No cached deployment for removed service $svc; skipping down"
            fi
          done


