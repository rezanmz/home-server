name: Deploy to Raspberry Pi

on:
  push:
    branches: [ "main" ]
    paths:
      - 'services/**'
      - '.github/workflows/deploy.yml'

concurrency:
  group: deploy-home-server
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    env:
      # Make secrets available to all compose runs. Add more here as your services require.
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      DEPLOY_STATE_DIR: ${{ github.workspace }}/.deploy-state/services
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy changed services and stop removed ones
        shell: bash
        run: |
          set -euo pipefail

          AFTER_SHA="${GITHUB_SHA}"
          BEFORE_SHA="${{ github.event.before }}"

          if [[ -z "${BEFORE_SHA}" || "${BEFORE_SHA}" == "0000000000000000000000000000000000000000" ]]; then
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              BEFORE_SHA="$(git rev-parse HEAD^)"
            else
              BEFORE_SHA="$(git rev-list --max-parents=0 -n 1 HEAD)"
            fi
          fi

          echo "Before: ${BEFORE_SHA}"
          echo "After:  ${AFTER_SHA}"

          mkdir -p "${DEPLOY_STATE_DIR}"

          # Current services in workspace (dirs under services/* that contain compose.yml/yaml)
          mapfile -t CURRENT_SERVICES < <(find services -mindepth 2 -maxdepth 2 \( -name 'compose.yaml' -o -name 'compose.yml' \) -print \
            | awk -F/ '{print $2}' | sort -u)

          # Services present in the previous commit
          mapfile -t PREV_SERVICES < <(git ls-tree -r --name-only "${BEFORE_SHA}" -- services 2>/dev/null \
            | awk -F/ '/(^|\/)compose\.(ya)?ml$/{print $2}' | sort -u || true)

          # Services that have any file changes in this push
          mapfile -t CHANGED_SERVICES < <(git diff --name-only "${BEFORE_SHA}" "${AFTER_SHA}" -- services 2>/dev/null \
            | awk -F/ '{print $2}' | sort -u || true)

          # Helper to test membership
          in_list() { local x="$1"; shift; for i in "$@"; do [[ "$i" == "$x" ]] && return 0; done; return 1; }

          echo "Current services: ${CURRENT_SERVICES[*]:-<none>}"
          echo "Previous services: ${PREV_SERVICES[*]:-<none>}"
          echo "Changed services: ${CHANGED_SERVICES[*]:-<none>}"

          # Determine removed services = prev - current
          REMOVED_SERVICES=()
          for svc in "${PREV_SERVICES[@]:-}"; do
            if ! in_list "$svc" "${CURRENT_SERVICES[@]:-}"; then
              REMOVED_SERVICES+=("$svc")
            fi
          done

          echo "Removed services: ${REMOVED_SERVICES[*]:-<none>}"

          # Deploy changed or newly added services
          for svc in "${CHANGED_SERVICES[@]:-}"; do
            if in_list "$svc" "${CURRENT_SERVICES[@]:-}"; then
              echo "Deploying: $svc"
              pushd "services/$svc" >/dev/null
              docker compose -f compose.yaml pull | cat
              docker compose -f compose.yaml up -d --remove-orphans | cat
              popd >/dev/null
              mkdir -p "${DEPLOY_STATE_DIR}/$svc"
              rsync -a --delete "services/$svc/" "${DEPLOY_STATE_DIR}/$svc/"
            fi
          done

          # Stop services removed from the repo
          for svc in "${REMOVED_SERVICES[@]:-}"; do
            if [[ -d "${DEPLOY_STATE_DIR}/$svc" ]]; then
              echo "Stopping removed service: $svc"
              pushd "${DEPLOY_STATE_DIR}/$svc" >/dev/null
              docker compose -f compose.yaml down | cat || true
              popd >/dev/null
              rm -rf "${DEPLOY_STATE_DIR}/$svc"
            else
              echo "No cached deployment for removed service $svc; skipping down"
            fi
          done


