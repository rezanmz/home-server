name: nginx

services:
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./html:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - /var/lib/home-server/nginx/letsencrypt:/etc/letsencrypt
    command: >-
      sh -c "apk add --no-cache openssl inotify-tools >/dev/null 2>&1 || true; \
      if [ ! -f /etc/letsencrypt/live/reza.network/fullchain.pem ]; then \
        mkdir -p /etc/letsencrypt/live/reza.network; \
        openssl req -x509 -nodes -newkey rsa:2048 -days 1 -keyout /etc/letsencrypt/live/reza.network/privkey.pem -out /etc/letsencrypt/live/reza.network/fullchain.pem -subj '/CN=reza.network'; \
      fi; \
      (inotifywait -m -e close_write,create,delete /etc/letsencrypt/live/reza.network 2>/dev/null \
        | while read -r _; do nginx -s reload || true; done) & \
      nginx -g 'daemon off;'"

  certbot:
    image: certbot/dns-cloudflare:latest
    container_name: certbot
    restart: unless-stopped
    environment:
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
    volumes:
      - /var/lib/home-server/nginx/letsencrypt:/etc/letsencrypt
    depends_on:
      - nginx
    entrypoint: sh
    command: -c "set -e; \
      mkdir -p /etc/letsencrypt; \
      printf 'dns_cloudflare_api_token = %s\n' \"$CLOUDFLARE_API_TOKEN\" > /etc/letsencrypt/cloudflare.ini; \
      chmod 600 /etc/letsencrypt/cloudflare.ini; \
      first_issue() { \
        EXTRA=""; \
        if [ \"${LETSENCRYPT_STAGING:-}\" = \"true\" ]; then EXTRA="--test-cert"; fi; \
        certbot certonly --dns-cloudflare --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini \
          -d reza.network --agree-tos --non-interactive --email \"$LETSENCRYPT_EMAIL\" --rsa-key-size 4096 $EXTRA; \
      }; \
      renew_loop() { \
        while true; do \
          EXTRA=""; \
          if [ \"${LETSENCRYPT_STAGING:-}\" = \"true\" ]; then EXTRA="--test-cert"; fi; \
          certbot renew --quiet --no-self-upgrade $EXTRA || true; \
          sleep 12h; \
        done; \
      }; \
      if [ ! -f /etc/letsencrypt/live/reza.network/fullchain.pem ]; then first_issue; fi; \
      renew_loop"


